<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />
<title>ECE 411: MP4 Documentation</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 8954 2022-01-20 10:10:25Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See https://docutils.sourceforge.io/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

.subscript {
  vertical-align: sub;
  font-size: smaller }

.superscript {
  vertical-align: super;
  font-size: smaller }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left, table.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right, table.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

table.align-center {
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

.align-top    {
  vertical-align: top }

.align-middle {
  vertical-align: middle }

.align-bottom {
  vertical-align: bottom }

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

/* "booktabs" style (no vertical lines) */
table.docutils.booktabs {
  border: 0px;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.docutils.booktabs * {
  border: 0px;
}
table.docutils.booktabs th {
  border-bottom: thin solid;
  text-align: left;
}

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="ece-411-mp4-documentation">
<h1 class="title">ECE 411: MP4 Documentation</h1>
<h2 class="subtitle" id="an-out-of-order-implementation-of-the-rv32i-processor">An Out-of-Order Implementation of the RV32I Processor</h2>

<!-- .. raw:: html -->
<!--  -->
<!-- <style> .red {color: red} .redst {color: red; text-decoration: line-through}</style> -->
<blockquote>
<p>The software programs described in this document are confidential and proprietary products of
Altera Corporation and Mentor Graphics Corporation or its licensors. The terms and conditions
governing the sale and licensing of Altera and Mentor Graphics products are set forth in written
agreements between Altera, Mentor Graphics and its customers. No representation or other
affirmation of fact contained in this publication shall be deemed to be a warranty or give rise
to any liability of Altera and Mentor Graphics whatsoever. Images of software programs in use
are assumed to be copyright and may not be reproduced.</p>
<p>This document is for informational and instructional purposes only. The ECE 411 teaching staff
reserves the right to make changes in specifications and other information contained in this
publication without prior notice, and the reader should, in all cases, consult the teaching
staff to determine whether any changes have been made.</p>
</blockquote>
<div class="contents topic" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="auto-toc simple">
<li><a class="reference internal" href="#introduction" id="toc-entry-1">1&nbsp;&nbsp;&nbsp;Introduction</a></li>
<li><a class="reference internal" href="#getting-started" id="toc-entry-2">2&nbsp;&nbsp;&nbsp;Getting Started</a><ul class="auto-toc">
<li><a class="reference internal" href="#working-as-a-group" id="toc-entry-3">2.1&nbsp;&nbsp;&nbsp;Working as a Group</a></li>
<li><a class="reference internal" href="#mentor-tas" id="toc-entry-4">2.2&nbsp;&nbsp;&nbsp;Mentor TAs</a></li>
<li><a class="reference internal" href="#testing" id="toc-entry-5">2.3&nbsp;&nbsp;&nbsp;Testing</a></li>
</ul>
</li>
<li><a class="reference internal" href="#tomasulo-algorithm" id="toc-entry-6">3&nbsp;&nbsp;&nbsp;Tomasulo Algorithm</a><ul class="auto-toc">
<li><a class="reference internal" href="#front-end" id="toc-entry-7">3.1&nbsp;&nbsp;&nbsp;Front End</a></li>
<li><a class="reference internal" href="#execution" id="toc-entry-8">3.2&nbsp;&nbsp;&nbsp;Execution</a></li>
<li><a class="reference internal" href="#commit-retire" id="toc-entry-9">3.3&nbsp;&nbsp;&nbsp;Commit/Retire</a></li>
</ul>
</li>
<li><a class="reference internal" href="#project-milestones" id="toc-entry-10">4&nbsp;&nbsp;&nbsp;Project Milestones</a><ul class="auto-toc">
<li><a class="reference internal" href="#checkpoints" id="toc-entry-11">4.1&nbsp;&nbsp;&nbsp;Checkpoints</a><ul class="auto-toc">
<li><a class="reference internal" href="#checkpoint-1-initial-progress" id="toc-entry-12">4.1.1&nbsp;&nbsp;&nbsp;Checkpoint 1: Initial Progress</a></li>
<li><a class="reference internal" href="#checkpoint-2-rv32i-isa-and-basic-ooo" id="toc-entry-13">4.1.2&nbsp;&nbsp;&nbsp;Checkpoint 2: RV32I ISA and Basic OoO</a></li>
<li><a class="reference internal" href="#checkpoint-3-l1-caches-arbiter-and-static-branch-prediction" id="toc-entry-14">4.1.3&nbsp;&nbsp;&nbsp;Checkpoint 3: L1 caches, arbiter and static branch prediction</a></li>
<li><a class="reference internal" href="#checkpoint-4-design-competition" id="toc-entry-15">4.1.4&nbsp;&nbsp;&nbsp;Checkpoint 4: design competition</a></li>
<li><a class="reference internal" href="#final-submission" id="toc-entry-16">4.1.5&nbsp;&nbsp;&nbsp;Final Submission</a></li>
</ul>
</li>
<li><a class="reference internal" href="#presentation-and-report" id="toc-entry-17">4.2&nbsp;&nbsp;&nbsp;Presentation and Report</a></li>
</ul>
</li>
<li><a class="reference internal" href="#grading" id="toc-entry-18">5&nbsp;&nbsp;&nbsp;Grading</a><ul class="auto-toc">
<li><a class="reference internal" href="#progress-report-and-roadmaps" id="toc-entry-19">5.1&nbsp;&nbsp;&nbsp;Progress Report and Roadmaps</a></li>
<li><a class="reference internal" href="#advanced-features" id="toc-entry-20">5.2&nbsp;&nbsp;&nbsp;Advanced Features</a></li>
<li><a class="reference internal" href="#design-competition" id="toc-entry-21">5.3&nbsp;&nbsp;&nbsp;Design Competition</a></li>
<li><a class="reference internal" href="#group-evaluations" id="toc-entry-22">5.4&nbsp;&nbsp;&nbsp;Group Evaluations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#design-guidelines" id="toc-entry-23">6&nbsp;&nbsp;&nbsp;Design Guidelines</a><ul class="auto-toc">
<li><a class="reference internal" href="#basic-design" id="toc-entry-24">6.1&nbsp;&nbsp;&nbsp;Basic Design</a></li>
<li><a class="reference internal" href="#advanced-design-options" id="toc-entry-25">6.2&nbsp;&nbsp;&nbsp;Advanced Design Options</a></li>
</ul>
</li>
<li><a class="reference internal" href="#design-considerations" id="toc-entry-26">7&nbsp;&nbsp;&nbsp;Design Considerations</a></li>
<li><a class="reference internal" href="#faqs" id="toc-entry-27">8&nbsp;&nbsp;&nbsp;FAQs</a></li>
<li><a class="reference internal" href="#advice-from-past-students" id="toc-entry-28">9&nbsp;&nbsp;&nbsp;Advice from Past Students</a></li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="introduction">
<h1><a class="toc-backref" href="#toc-entry-1">1&nbsp;&nbsp;&nbsp;Introduction</a></h1>
<p>This machine problem involves the design of a pipelined, out-of-order microprocessor. You are
required to implement the RV32I instruction set (with the exception of <tt class="docutils literal">FENCE*</tt>, <tt class="docutils literal">ECALL</tt>,
<tt class="docutils literal">EBREAK</tt>, and <tt class="docutils literal">CSRR</tt> instructions) using the pipelining techniques described in lectures. You
have freedom to vary the exact out-of-order microarchitectural details. This handout is an
incomplete specification to get you started with your design, a portion of this machine problem is
left open ended for you to explore design options that interest you.</p>
<p>You will begin your design by creating a non-speculative out-of-order pipeline that can execute the
RV32I instruction set, and supports in order commit via the reorder buffer (ROB). Then, you will
add support for branch prediction and integrate a basic cache system. After implementing a
functional pipeline that can execute the RV32I ISA, you will have the opportunity to expand your
design with advanced design options of your choosing. Note that you are not required to implement
advanced design features to receive full credit, however they may be useful in improving
performance. You will not compete in the same design competition as in order pipeline groups, but
will be evaluated on a different scale with the baseline and other out-of-order teams. Your main
goal should be functional correctness.</p>
</div>
<div class="section" id="getting-started">
<h1><a class="toc-backref" href="#toc-entry-2">2&nbsp;&nbsp;&nbsp;Getting Started</a></h1>
<div class="section" id="working-as-a-group">
<h2><a class="toc-backref" href="#toc-entry-3">2.1&nbsp;&nbsp;&nbsp;Working as a Group</a></h2>
<p>For this assignment, you must work in a group of three people (unless the class size is not a
multiple of three or you have been approved by the course staff). It will be your responsibility to
work on the assignment as a team. Every member should be knowledgeable about all aspects of your
design, so do not silo responsibilities and expect everything to work when you put the parts
together. Good teams will communicate often and discuss issues (either with the
design/implementation or with teamwork) that arise in a timely manner.</p>
<p>To aid collaboration, we provide a private Github repository <a class="footnote-reference" href="#footnote-1" id="footnote-reference-1">[1]</a> that you can use to share code
within your team and with your TA.</p>
<p>Part of working well as a team is being courteous to the rest of the team, even when you plan to
drop the class. We ask that you let TAs and the rest of your team know as soon as possible if you
plan to drop ECE 411, so we can reassign other people and minimize the number of issues later in
the semester.</p>
<table class="docutils footnote" frame="void" id="footnote-1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-1">[1]</a></td><td>Your repository may not be immediately available as team assignments need to be finalized,
and then the repositories are all created manually. You will be able to find the repository in
the same location as your MP repository when it is ready.</td></tr>
</tbody>
</table>
</div>
<div class="section" id="mentor-tas">
<h2><a class="toc-backref" href="#toc-entry-4">2.2&nbsp;&nbsp;&nbsp;Mentor TAs</a></h2>
<p>Given that every group's design will be different in MP4, it is often difficult for a TA unfamiliar
with your group to answer all of your questions. In order to make sure that each group has someone
who is knowledgeable about their design, each group will be assigned a mentor TA. You will have
regular meetings with your mentor TA, so that they know how your project is doing and any major
hurdles you have encountered along the way. You must meet with your mentor TA at least once every
week. Scheduling these meetings is <em>your</em> responsibility. Check with your mentor TA for their
preferred scheduling method/availability. In the past, some teams skipped the meetings without
contacting mentor TAs in advance, and we have received course feedback asking that they be made
mandatory.</p>
<p>Your first meeting with your mentor TA will be not only to review your paper design for your basic
pipeline, but also to discuss your goals for the project. Before meeting with your mentor TA, you
should have discussed in detail with your team about what design options you plan to explore. Your
mentor TA may advise against certain options, but you are free to work on whatever you like. As the
project progresses, you may find that your goals and your design change. This is normal and you are
free to take the project in a direction that interests you. However, you must keep your mentor TA
up to date about any changes you have made or plan to make.</p>
<p>In order to get the most out of your relationship with your mentor TA, you should approach the
relationship as if your group has been hired into a company and given the MP4 design as a job
assignment. A senior engineer has been assigned to help you stay on schedule and not get
overwhelmed by tool problems or design problems. <em>Do not</em> think of the TA as an obstacle or hostile
party. <em>Do not</em> try to &quot;protect&quot; your design from the TA by not allowing him or her to see defects
or problem areas. <em>Do not</em> miss appointments or engage in any other unprofessional conduct. If you
plan to make a late submission, your mentor TA should know as soon as possible, so they can make
sure you are still on track. Your mentor TA should be a consulting member of your team, not an
external bureaucrat.</p>
</div>
<div class="section" id="testing">
<h2><a class="toc-backref" href="#toc-entry-5">2.3&nbsp;&nbsp;&nbsp;Testing</a></h2>
<p>Throughout the MP, you will need to generate your own test code and verification strategy. This is
extremely important as untested components may lead to failing the final test code and competition
benchmark altogether. Out-of-order CPUs are significantly more complex than in order ones.
Verifying full correctness can take time. You cannot just test that your processor executes each of
the instructions correctly in isolation. You should try to generate test code to test as many
corner cases as you can think of. In addition, we strongly encourage that you use the verification
techniques that you have learned so far in class to generate additional tests.</p>
<p>Due to the flexibility of your design, we cannot provide a ready-to-go instantiation of the RVFI
monitor as we have in the past. You will need to figure out how to hook the monitor up on your
own.</p>
<p>Teams looking to design a non-superscalar processor with single commits should be able to use the
given RVFI monitor to verify their design. However, due to the flexibility of your design, we
cannot provide a ready-to-go instantiation of the RVFI monitor as we have in the past. You will
need to figure out how to hook the monitor up on your own. For help, you can visit the RVFI
Monitor's <a class="reference external" href="https://github.com/SymbioticEDA/riscv-formal">GitHub page</a>.</p>
<p>Teams looking to design a superscalar OoO processor or a processor supporting multiple simultaneous
commits may find it easier to create a golden software model that can execute instructions
perfectly. In comparison to the RVFI monitor, which aims to be synthesizable, your golden software
model only needs to run in simulation, allowing you to execute multiple instructions within a
single cycle using the outputs of the previously executed instruction as inputs to the next
instruction being executed. This model can be written in SystemVerilog or another language. Every
time your out-of-order CPU commits an instruction, the software model should also commit an
instruction. At this point the architectural state of the model and CPU can be checked for
consistency. If there is a difference between the two architectural states, a fatal error can be
thrown describing the difference in state as well as the incorrectly executed instruction. This is
an effective way to ensure functional correctness of your design (although this method will not
catch performance bugs or memory issues).</p>
<p>As always, we expect you to fully read through all provided code and documentation before starting
your design. There may be requirements not explicitly mentioned in this documentation but are made
clear through a basic reading of the provided code. The TAs will make every effort to ensure
completeness of the documentation, but please read the provided code as well.</p>
</div>
</div>
<div class="section" id="tomasulo-algorithm">
<h1><a class="toc-backref" href="#toc-entry-6">3&nbsp;&nbsp;&nbsp;Tomasulo Algorithm</a></h1>
<p>We recommend that all OoO teams implement their processors with the Tomasulo Algorithm, which is the
same algorithm taught in this class's lecture. While you are free to implement your processor using
a different design (e.g. scoreboarding), the TA's may not be able to offer as much assistance in
your design and debugging stages.</p>
<div class="section" id="front-end">
<h2><a class="toc-backref" href="#toc-entry-7">3.1&nbsp;&nbsp;&nbsp;Front End</a></h2>
<p>The front end consists of your instruction fetch, instruction queue, instruction decode, and
instruction issue. Even with OoO processors, instructions are fetched and issued in order. Your
processor's front end will be very similar to an in order team's front end.</p>
<p>Your instruction fetch will need to request the data for the next instruction from the instruction
cache based on the current PC, then put that instruction onto the instruction queue. It will also
need to perform any branch prediction to find and update the next PC value (for branches, JAL, and
JALR instructions). From the perspective of the instruction fetch, an instruction can be
considered &quot;executed&quot; as soon as it gets put onto the instruction queue. This means your PC
register will be &quot;ahead&quot; of whatever instruction is currently actually being executed and retired
by the later stages.</p>
<p>The purpose of the instruction queue is to provide a buffer between the instruction fetch and the
execution unit(s). While your execution units might be stalled waiting on a dependency to resolve,
your instruction fetch can still add new instructions to the queue. Likewise, while your
instruction fetch stalls because of an instruction cache miss, your execution unit(s) can still be
issued new instructions.</p>
<p>The instruction issue is the stage where an instruction is taken out of the instruction queue, any
register dependencies are checked (e.g. checking the regfile for a ROB tag), and data is loaded
into the reservation station(s).</p>
<p>When designing your front end, keep in mind the different stall conditions and flush conditions. For
example, if there are no more instructions left on the instruction queue, you must stall the
instruction issue to avoid issuing garbage data to your reservation stations. Similarly, if the
instruction queue fills up, you must temporarily stall the instruction fetch stage since there is
nowhere to put the newly fetched data.</p>
</div>
<div class="section" id="execution">
<h2><a class="toc-backref" href="#toc-entry-8">3.2&nbsp;&nbsp;&nbsp;Execution</a></h2>
<p>The execution stage primarily consists of your reservation station(s) and load/store queue.</p>
<p>Because dependencies between instructions are automatically handled by the algorithm with ROB tags,
it is trivial to add additional reservation stations and execution units. For example, you can
design your processor with multiple ALUs to concurrently execute instructions as their dependencies
get satisfied. For simplicity, you may also choose to attach an ALU to every single reservation
station.</p>
<p>The load/store queue is responsible for handling any memory instructions such as <tt class="docutils literal">lw</tt>, <tt class="docutils literal">lh</tt>,
<tt class="docutils literal">lb</tt>, <tt class="docutils literal">sw</tt>, <tt class="docutils literal">sh</tt>, <tt class="docutils literal">sb</tt>, etc. We recommend that most teams handle all memory operations in
an in order fashion, which means creating a single queue for both loads and stores. While it is
possible to execute memory operations out-of-order, it adds significant complexity to your
processor's logic and flushing mechanisms and won't be covered in this document. Trying to handle
memory operations out-of-order would mean needing to perform dynamic memory disambiguation or
memory dependence speculation.</p>
</div>
<div class="section" id="commit-retire">
<h2><a class="toc-backref" href="#toc-entry-9">3.3&nbsp;&nbsp;&nbsp;Commit/Retire</a></h2>
<p>To allow for the speculative execution of instructions, all instructions need to be placed in your
reorder buffer (ROB) during instruction issue. While instructions may be executed out-of-order,
they should only be retired in order. This means your processor should not perform a memory write
or change the regfile until an instruction is ready to be retired.</p>
<p>Upon discovery of a branch misprediction, you will need to flush parts of your processor including
the instruction queue, reservation station(s), load/store queue, and reorder buffer. You can choose
to flush either as soon as a branch misprediction is detected, or you can wait until the
misprediction reaches the head of the ROB and is ready to be retired.</p>
<p>In the former case, the process of flushing is slightly more complicated, but you will see better
performance as you are not unnecessarily executing instructions. Since the branch misprediction is
not at the head of the ROB, you will need to perform a &quot;selective flush&quot; on your ROB, load/store
queue, and reservation stations. This is because these data structures constains instructions from
both before the branch and after the branch -- we only want to flush the instructions that were
issued after the branch. In some instances, this can completely eliminate the misprediction penalty
of a branch instruction (e.g. when there is a long memory operation that needs to commit before the
branch).</p>
<p>In the latter case, the process of flushing is simpler since all instructions issued before the
branch have already been committed (since the branch is at the head of the ROB). Therefore, we can
simply flush the entire ROB, the entire load/store queue, and all reservation station(s).</p>
</div>
</div>
<div class="section" id="project-milestones">
<h1><a class="toc-backref" href="#toc-entry-10">4&nbsp;&nbsp;&nbsp;Project Milestones</a></h1>
<p>MP4 is divided into several submissions to help you manage your progress. The dates for submissions
are provided in the class schedule. Late work will be based on the deadlines for each individual
milestone, with each part of a checkpoint submission evaluated separately. (For example, submitting
a paper design late will result in penalties for that paper design only.) Out-of-order checkpoints
have different requirements than in order checkpoints, but the deadlines are the same unless
specified by your TA.</p>
<div class="section" id="checkpoints">
<h2><a class="toc-backref" href="#toc-entry-11">4.1&nbsp;&nbsp;&nbsp;Checkpoints</a></h2>
<p>There will be four checkpoints to keep you on track for this MP. For each checkpoint, you will be
required to have implemented a certain amount of the functionality for your processor design. In
addition, at each checkpoint, you must meet, as a team, with your mentor TA and provide him or her
with the following information in writing:</p>
<ul class="simple">
<li>A brief report detailing progress made since the previous checkpoint. This should include what
functionality you implemented and tested as well as how each member of the group contributed.</li>
<li>A roadmap for what you will be implementing for the following checkpoint. The roadmap should
include a breakdown of who will be responsible for what and paper designs for all design options
that you are planning to implement for the next checkpoint.</li>
</ul>
<p>Refer to the <a class="reference internal" href="#progress-report-and-roadmaps">Progress Report and Roadmaps</a> section for more details on writing these reports.</p>
<p>Besides helping the TAs check your progress on the MP, the checkpoints are an opportunity for you to
get answers to any questions that may have come up during the design process. You should use this
time to get clarifications or advice from your mentor TA.</p>
<p>Note that the checkpoint requirements outline the minimum amount of work that should have been
completed since the start of the project. You should work ahead where possible to have more time to
complete advanced design options.</p>
<div class="section" id="checkpoint-1-initial-progress">
<h3><a class="toc-backref" href="#toc-entry-12">4.1.1&nbsp;&nbsp;&nbsp;Checkpoint 1: Initial Progress</a></h3>
<p>By checkpoint 1, you should have at least one module (e.g. instruction queue, load/store queue,
reorder buffer, reservation station, etc.) completed and fully verified with a unit testbench. We
recommend starting with the instruction queue. <strong>Your instruction queue must be parameterized!</strong></p>
<p>While you only need to submit one completed module, we recommend you start working on additional
modules if you have extra time. You should give yourself as much time as possible to debug your
processor before checkpoints 2 and 3.</p>
</div>
<div class="section" id="checkpoint-2-rv32i-isa-and-basic-ooo">
<h3><a class="toc-backref" href="#toc-entry-13">4.1.2&nbsp;&nbsp;&nbsp;Checkpoint 2: RV32I ISA and Basic OoO</a></h3>
<p>By checkpoint 2, you should have a basic out-of-order machine that can handle all of the RV32I
instructions (with the exception of <tt class="docutils literal">FENCE*</tt>, <tt class="docutils literal">ECALL</tt>, <tt class="docutils literal">EBREAK</tt>, and <tt class="docutils literal">CSRR</tt> instructions).
The test code will contain NOPs to allow the processor to work without branch prediction. For this
checkpoint you can use a dual-port &quot;magic&quot; memory that always sets <tt class="docutils literal">mem_resp</tt> high immediately,
so that you do not have to handle cache misses or memory stalls.</p>
<p>By the end of this checkpoint, you must provide your mentor TA with paper designs for branch
prediction if not already present in the initial design, as well as a design for your arbiter to
interface your instruction and data cache with the CPU and main memory.</p>
</div>
<div class="section" id="checkpoint-3-l1-caches-arbiter-and-static-branch-prediction">
<h3><a class="toc-backref" href="#toc-entry-14">4.1.3&nbsp;&nbsp;&nbsp;Checkpoint 3: L1 caches, arbiter and static branch prediction</a></h3>
<p>By checkpoint 3, your CPU should be able to do static-not-taken branch prediction. This includes
adding logic to flush incorrect instructions on branch miss predictions.</p>
<p>You must also have an arbiter implemented and integrated, such that both split caches (I-Cache and
D-Cache) connect to the arbiter, which interfaces with memory. Since main memory only has a single
port, your arbiter determines the priority on which cache request will be served first in the case
when both caches miss and need to access memory on the same cycle.</p>
<p>For groups who do not have a fully functional cache available, we will be providing a small cache
for the purposes of this checkpoint. We encourage groups to use their own designs if available, on
this checkpoint or when moving forward to your advanced design features.</p>
<p>At this point, you do not need to provide your mentor TA with proposals for advanced features. Since
you are working on an out-of-order processor, you already have all 20 points of your advanced
feature design points, any extra advanced feature designs you choose to work on will be considered
extra credit (capped at a limit set by the TAs). However, you may still choose to submit a report
with advanced feature designs for your mentor TA to review. These may be as detailed as you deem
necessary -- anything from a written description to a hardware paper design. Your TA may have
feedback on implementation details or potential challenges, so the more detail you provide now, the
more helpful your TA can be.</p>
</div>
<div class="section" id="checkpoint-4-design-competition">
<h3><a class="toc-backref" href="#toc-entry-15">4.1.4&nbsp;&nbsp;&nbsp;Checkpoint 4: design competition</a></h3>
<p>By checkpoint 4, you must have your final, optimized design ready for the competition. This means
that you should have a fully functional design that can run all provided test code and competition
code.</p>
<p>While implementing advanced features will help you earn extra design points, you should be designing
with performance in mind. In order to motivate performance-centric thinking, part of your CP4 grade
will be determined by your design's best execution time on the competition test codes we provide.
Your score in the competition will be based on your relative performance to other out-of-order
teams in the class. Scoring for out-of-order groups will not be on the same curve as in order
groups. Please consult your TA for details about the scoring of the competition as this may be
dependent on the number of out-of-order groups and the nature of your design. In order to be
eligible for these points, you should:</p>
<ul class="simple">
<li>Ensure that your code works correctly. <strong>Designs which cannot 100% correctly execute the
competition code will receive 0 points for the performance part.</strong></li>
<li>You <em>may</em> use a separate design for advanced feature grading and for the competition (i.e., you do
not have to be timed with you advanced features if they cause a performance hit on the
competition codes).</li>
</ul>
</div>
<div class="section" id="final-submission">
<h3><a class="toc-backref" href="#toc-entry-16">4.1.5&nbsp;&nbsp;&nbsp;Final Submission</a></h3>
<p>Checkpoint 4 marks the end of this MP. Your final submission should include all design,
verification, and testcode files used for your CP4 design. You can choose to demo your final
submission with your TA to receive extra credit for any advanced features and competition. If your
designs are different, this is where you may show the changes.</p>
<p>For the final demo, your design should have the CPU and any optional advanced features working
correctly. You should be able to demonstrate any advanced features that you expect to get extra
design points for, with your own test codes. You should also know how different feature affects the
performance of your machine (including design paramters, module sizes, advanced features, etc).</p>
</div>
</div>
<div class="section" id="presentation-and-report">
<h2><a class="toc-backref" href="#toc-entry-17">4.2&nbsp;&nbsp;&nbsp;Presentation and Report</a></h2>
<p>At the conclusion of the project, you will give a short presentation to the course staff (and fellow
students) about your design. In addition, you need to collect your checkpoint progress reports
and paper designs together as a final report that documents your accomplishments. <strong>More information
about both the presentation and report will be released closer to the deadline.</strong></p>
</div>
</div>
<div class="section" id="grading">
<h1><a class="toc-backref" href="#toc-entry-18">5&nbsp;&nbsp;&nbsp;Grading</a></h1>
<p>MP4 will be graded out of 120 points, plus 18 points for extra credit. Out of the 120 + 18 points,
60 points are allocated for regularly meeting with your TA, for submitting paper designs of various
parts of your design, for a final presentation given to the course staff, and for documenting your
design with a final report. For each checkpoint, you must meet with your mentor TA in order to
showcase the functionality of your design and your verification methods. Implementation points will
NOT be given otherwise.</p>
<p>A breakdown of points for MP4 is given in <a class="reference internal" href="#table-1">Table 1</a>. Points are organized into two categories
across six submissions. Note that the number of points you can attain depends on what additional
advanced design options you wish to pursue.</p>
<table border="1" class="docutils" id="table-1">
<colgroup>
<col width="15%" />
<col width="43%" />
<col width="43%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">&nbsp;</th>
<th class="head">Implementation [60+18]</th>
<th class="head">Documentation [60]</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>Design [7]</td>
<td>&nbsp;</td>
<td><ul class="first last simple">
<li>TA Meeting [2]</li>
<li>Basic RV32I OoO design [5]</li>
</ul>
</td>
</tr>
<tr><td>CP 1 [14]</td>
<td><ul class="first last simple">
<li>One module completed and verified [8]</li>
</ul>
</td>
<td><ul class="first last simple">
<li>TA Meeting [2]</li>
<li>Progress report [2]</li>
<li>Roadmap [2]</li>
</ul>
</td>
</tr>
<tr><td>CP 2 [19+3]</td>
<td><ul class="first last simple">
<li>Basic OoO datapath [8]</li>
<li>Competition code comp1.s runs [+1]</li>
<li>Competition code comp2_i.s runs [+1]</li>
<li>Competition code comp3.s runs [+1]</li>
</ul>
</td>
<td><ul class="first last simple">
<li>TA Meeting [2]</li>
<li>Progress report [2]</li>
<li>Roadmap [2]</li>
<li>Arbiter &amp; branch predictor design [5]</li>
</ul>
</td>
</tr>
<tr><td>CP 3 [38+15]</td>
<td><ul class="first last simple">
<li>Complete functional OoO datapath [20]</li>
<li>Integration of L1 caches [2]</li>
<li>Arbiter [3]</li>
<li>Static branch predictor [7]</li>
<li>Extra advanced design options [+15]</li>
</ul>
</td>
<td><ul class="first last simple">
<li>TA Meeting [2]</li>
<li>Progress report [2]</li>
<li>Roadmap [2]</li>
</ul>
</td>
</tr>
<tr><td>CP 4 [42]</td>
<td><ul class="first last simple">
<li>Design competition [12]</li>
</ul>
</td>
<td><ul class="first last simple">
<li>Presentation [10]</li>
<li>Report [20]</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Table 1: MP4 point breakdown for OoO teams. Points for each item are enclosed in brackets. Point
numbers after &quot;+&quot; signs are extra credits.</p>
<p>The late penalty of this course will apply to work you submit late, so if you have something ready
by the deadline, be sure to show it to your TA.</p>
<p>Additionally, there will be a small penalty for having independently functional design units that
are not successfully integrated. If you can demonstrate to your TA that each item works on its own,
you will receive full credit for that unit. Rather than deducting all of the implementation points,
failure to integrate design units will result in a 30% penalty. You may recover half of the lost
points by demonstrating full integration at a later date.</p>
<div class="section" id="progress-report-and-roadmaps">
<h2><a class="toc-backref" href="#toc-entry-19">5.1&nbsp;&nbsp;&nbsp;Progress Report and Roadmaps</a></h2>
<p>You are responsible for submitting a progress report and a roadmap for each checkpoint. While these
may not seem like many points, they are instrumental in helping you and your mentor TA track your
progress, and can help address any issues you may have before they blow up.</p>
<p>Your progress report should mention, at minimum, the following:</p>
<ul class="simple">
<li>who worked on each part of the design</li>
<li>the functionalities you implemented</li>
<li>the testing strategy you used to verify these functionalities</li>
</ul>
<p>You should be both implementing and verifying the design as you progress through the assignment. It
will also be useful for you to include an updated datapath with each progress report, as your
design will inevitably change as you complete the assignment. Making sure your datapath is
up-to-date will help both you and your mentor TA track changes in your design and identify possible
issues. Additionally, a complete datapath will be required in your final report.</p>
<p>The roadmap should lay out the plan for the next checkpoint:</p>
<ul class="simple">
<li>who is going to implement and verify each feature or functionality you must complete</li>
<li>what are those features or functionalities</li>
</ul>
<p>It is also useful to think through specific issues you may run into, and have a plan for resolving
the issues.</p>
<p>These are not intended to be very long. A single page (single-spaced) will be more than sufficient
for both the progress report and the roadmap. Be sure to check with your mentor TA, as they may
have other details to include on your progress report and roadmap.</p>
</div>
<div class="section" id="advanced-features">
<h2><a class="toc-backref" href="#toc-entry-20">5.2&nbsp;&nbsp;&nbsp;Advanced Features</a></h2>
<p>Of the 60 implementation points, 28 will come from the implementation of the basic pipeline and
memory hierarchy. Up to 20 points will be given for the implementation of advanced design options.
Up to 12 points will come from your group's performance in the design contest. To receive any
points for the advanced design features, you must have numerical data which shows a change to your
design's performance as compared to not having implemented the feature. The best way to provide
this data is using performance counters. For each advanced design option, points will be awarded
based on the three criteria below:</p>
<ul class="simple">
<li>Design and implementation: Your group has a clear understanding of what is to be built and how to
go about building it, and is able to produce a working implementation.</li>
<li>Testing strategy: The design is thoroughly tested with test code and/or test benchmarks that you
have written. Corner cases are considered and accounted for and you can prove that your design
works as expected.</li>
<li>Performance analysis: A summary of how the advanced design impacts the performance of your
processor. Does it improve or degrade performance? How is the performance impact vary across
different workloads? Why does the design improve or degrade performance?</li>
</ul>
<p>A list of advanced design options along with their point values are provided in the <a class="reference internal" href="#advanced-design-options">Advanced Design
Options</a> section.</p>
</div>
<div class="section" id="design-competition">
<h2><a class="toc-backref" href="#toc-entry-21">5.3&nbsp;&nbsp;&nbsp;Design Competition</a></h2>
<p>The design competition will be scored based on two metrics of your processor design for each of the
test codes we provide. These metrics are energy and delay. A design with lower energy consumption
and better performance will get your team ranked higher.</p>
<p>For each test code, your processor will be assigned a score calculated as <tt class="docutils literal">PD² * (100/Fmax)²</tt>, or
<tt class="docutils literal">energy * (delay * 100/Fmax)²</tt> <a class="footnote-reference" href="#footnote-2" id="footnote-reference-2">[2]</a>. The power used by your design is acquired through Quartus
using an activity factor generated by Modelsim. The factor of 100/Fmax is used to adjust the
simulation time based on your processor's maximum speed. Your final benchmark score will be the
geometric mean of your score on each test code.</p>
<p>To get full credit, you must exceed the baseline set by the TAs (announced at a later date). If you
are unable to exceed the baseline, and have proper justification for why, the majority of points
can still be earned. Because of the variability of out-of-order designs, it is up to you to
determine why your design may be functionally correct, and sufficiently complex, but less perfomant
than a simple in order design. You may earn makeup points (up to 10) based on your better
performance on these two scales:`</p>
<ul class="simple">
<li>The first scale is a straight linear scale ranking all of the teams in the design competition.
First place will receive full points, and non-functional designs will receive no points.</li>
<li>The second scale is a linear scale between the score of the best performing design and a baseline
MP4 CP3 design. The best score will receive full points, and the baseline design will receive no
points.</li>
<li>Your grade will be determined by the higher of these two scales. This ensures that very high
performing designs in a competitive class are not penalized unfairly.</li>
</ul>
<table class="docutils footnote" frame="void" id="footnote-2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-2">[2]</a></td><td>The exact formula may be changed for out-of-order groups depending on numbers.</td></tr>
</tbody>
</table>
</div>
<div class="section" id="group-evaluations">
<h2><a class="toc-backref" href="#toc-entry-22">5.4&nbsp;&nbsp;&nbsp;Group Evaluations</a></h2>
<p>At the end of the project, each group member will submit feedback on how well the group worked
together and how each member contributed to the project. The evaluation, along with feedback
provided at TA meetings throughout the semester, will be used to judge individual contribution to
the project. Up to 30 points may be deducted from a group member's score if it is evident that he
or she did not contribute to the project.</p>
<p>Although the group evaluation occurs at the end of the project, this should <em>not</em> be the first time
your mentor TA hears about problems that might be occurring. If there are major problems with
collaboration, the problems should be reflected in your TA meetings and progress reports. The
responses on the group evaluation should not come as a surprise to anyone.</p>
</div>
</div>
<div class="section" id="design-guidelines">
<h1><a class="toc-backref" href="#toc-entry-23">6&nbsp;&nbsp;&nbsp;Design Guidelines</a></h1>
<div class="section" id="basic-design">
<h2><a class="toc-backref" href="#toc-entry-24">6.1&nbsp;&nbsp;&nbsp;Basic Design</a></h2>
<p>You must complete an out-of-order pipelined RV32I design which consists of the following:</p>
<ul class="simple">
<li><strong>Datapath</strong><ul>
<li>Out-of-order machine which implements the full RV32I ISA (less excluded instructions) [8]</li>
<li>Static branch prediction [7]</li>
</ul>
</li>
<li><strong>Cache</strong><ul>
<li>Integration of instruction and data caches [2]</li>
<li>Arbiter [3]</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="advanced-design-options">
<h2><a class="toc-backref" href="#toc-entry-25">6.2&nbsp;&nbsp;&nbsp;Advanced Design Options</a></h2>
<p>The following sections describe some common advanced design options. Each design option is assigned
a point value (listed in brackets). Also note that based on design effort, your mentor TA can
decide to take off or add points to a design option. To obtain full points for a design option, you
must satisfy all the requirements given in the <a class="reference internal" href="#advanced-features">Advanced Features</a> grading section. If you would
like to add a feature to this list, you may work with your mentor TA to assign it a point value.</p>
<ul class="simple">
<li><a class="reference internal" href="#cache-organization-and-design-options">Cache organization and design options</a><ul>
<li><a class="reference internal" href="#l2-cache-system">L2+ cache system</a> [2] (Additional points up to TA discretion)</li>
<li><a class="reference internal" href="#way-set-associative-cache">4-way set associative cache</a> [2] (8+ way will be worth more points; up to TA discretion)</li>
<li><a class="reference internal" href="#parameterized-cache">Parameterized cache</a> [points up to TA discretion]</li>
<li>Alternative replacement policies [points up to TA discretion] <a class="footnote-reference" href="#footnote-3" id="footnote-reference-3">[3]</a></li>
</ul>
</li>
<li><a class="reference internal" href="#advanced-cache-options">Advanced cache options</a><ul>
<li><a class="reference internal" href="#eviction-write-buffer">Eviction write buffer</a> [4]</li>
<li><a class="reference internal" href="#victim-cache">Victim cache</a> [6]</li>
<li><a class="reference internal" href="#pipelined-l1-caches">Pipelined L1 caches</a> [6]</li>
<li><a class="reference internal" href="#non-blocking-l1-cache">Non-blocking L1 cache</a> [8]</li>
<li><a class="reference internal" href="#banked-l1-or-l2-cache">Banked L1 or L2 cache</a> [5]</li>
</ul>
</li>
<li><a class="reference internal" href="#branch-prediction-options">Branch prediction options</a><ul>
<li><a class="reference internal" href="#local-branch-history-table">Local branch history table</a> [2]</li>
<li><a class="reference internal" href="#global-2-level-branch-history-table">Global 2-level branch history table</a> [3]</li>
<li><a class="reference internal" href="#tournament-branch-predictor">Tournament branch predictor</a> [5]</li>
<li>LTAGE branch predictor [8]</li>
<li>Alternative branch predictor [points up to TA discretion] <a class="footnote-reference" href="#footnote-4" id="footnote-reference-4">[4]</a></li>
<li><a class="reference internal" href="#software-branch-predictor-model">Software branch predictor model</a> [2]</li>
<li>Branch target buffer, support for jumps [1]</li>
<li>4-way set associative or higher BTB [3]</li>
<li><a class="reference internal" href="#return-address-stack">Return address stack</a> [2]</li>
</ul>
</li>
<li><a class="reference internal" href="#prefetch-design-options">Prefetch design options</a><ul>
<li><a class="reference internal" href="#basic-hardware-prefetching">Basic hardware prefetching</a> [4]</li>
<li><a class="reference internal" href="#advanced-hardware-prefetching">Advanced hardware prefetching</a> [6]</li>
</ul>
</li>
<li><a class="reference internal" href="#difficult-design-options">Difficult design options</a><ul>
<li><a class="reference internal" href="#risc-v-m-extension">RISC-V M Extension</a>: A basic multiplier design is worth [3] while an
advanced muliplier is worth [5]</li>
<li><a class="reference internal" href="#risc-v-c-extension">RISC-V C Extension</a> [8]</li>
</ul>
</li>
<li><a class="reference internal" href="#superscalar-design-options">Superscalar design options</a><ul>
<li><a class="reference internal" href="#multiple-issue">Multiple issue</a> [15]</li>
</ul>
</li>
</ul>
<table class="docutils footnote" frame="void" id="footnote-3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-3">[3]</a></td><td>For example, <a class="reference external" href="http://old.gem5.org/Replacement_policy.html">http://old.gem5.org/Replacement_policy.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="footnote-4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-4">[4]</a></td><td>For example, Bi-Mode, TAGE, and Neural Branch Predictor</td></tr>
</tbody>
</table>
<hr class="docutils" />
<p id="cache-organization-and-design-options"><strong>Cache organization and design options</strong></p>
<ul id="l2-cache-system">
<li><p class="first"><strong>L2+ cache system</strong></p>
<p>Your L1 cache system is constrained to respond within 1 cycle on a hit in order to facilitate your
pipeline (unless you implement <a class="reference internal" href="#pipelined-l1-caches">Pipelined L1 caches</a>). Therefore, your L1 caches cannot be too
large without forming a large critical path, affecting your Fmax. This can be alleviated by
adding additional levels of caches, which may respond in more than one cycle. Having additional
caches can greatly speed up your design by keeping your Fmax high while also mitigating the
affects of memory stalling.</p>
<p>More complicated cache systems will be eligible for more advanced design feature points, feel free
to discuss your ideas/solutions with your mentor TA.</p>
</li>
</ul>
<ul id="way-set-associative-cache">
<li><p class="first"><strong>4-way set associative cache</strong></p>
<p>If 2-way in your caches is not enough, you can choose to implement a 4-way set associative cache
for any of your caches. The baseline is the pseudo-LRU replacement policy discussed in lectures.
You may choose to implement additional ways (8+) as well as any other replacement policy, both of
which will be eligible for additional points based on TA discretion.</p>
</li>
</ul>
<ul id="parameterized-cache">
<li><p class="first"><strong>Parameterized cache</strong>:</p>
<p>Instead of having statically sized caches, you can parameterize your cache to be able to use the
same cache module in different parts of your design. You can parameterize the size and the number
of sets, or also the number of ways or how many cycles it responds in. This feature will be
largely dependent on how much effort you take and how many factors are parameterized and will be
up to TA discretion.</p>
</li>
</ul>
<p id="advanced-cache-options"><strong>Advanced Cache Options</strong></p>
<ul id="eviction-write-buffer">
<li><p class="first"><strong>Eviction Write Buffer</strong></p>
<p>On a dirty block eviction, a cache will normally need to first write the block to the next cache
level, then fetch the missed address. An eviction write buffer is meant to hold dirty evicted
blocks between cache levels and allow the subsequent missed address be processed first, and when
the next level is free, proceed to write back the evicted block. This allows the CPU to receive
the missed data faster, instead of waiting for the dirty block to be written first.</p>
<p>The slightly more difficult version is a victim cache, which holds both dirty and clean evictions
(detailed below).</p>
</li>
</ul>
<ul id="victim-cache">
<li><p class="first"><strong>Victim Cache</strong></p>
<p>This is a version of the eviction write buffer on steroids. The buffer is expanded to be fully
associative with multiple entries (typically 8-16), it is filled with data even on clean
evictions, and is not necessarily written back to DRAM immediately. This enables a direct-mapped
cache to appear to have higher associativity by using the victim buffer only when conflict misses
occur. This is only recommended for groups who love cache.</p>
</li>
</ul>
<ul id="pipelined-l1-caches">
<li><p class="first"><strong>Pipelined L1 Caches</strong></p>
<p>Switching the two cycle hit caches from MP3 to a single cycle hit for MP4 can create a long
critical path and may affect your ability to meet timing. In addition, doing so precludes the
use of BRAM for your L1 caches. As opposed to switching to a single cycle hit, you may retain
the two cycle hits and have your caches process two requests at once. Your caches will recieve
a request in the first stage, and respond with the data in the second stage. While responding,
your cache should be able to process a new request in the first stage. This option must not
stall your pipeline on a hit, but may stall the pipeline on a miss.</p>
</li>
</ul>
<ul id="non-blocking-l1-cache">
<li><p class="first"><strong>Non-Blocking L1 Cache</strong></p>
<p>While a blocking cache serve a miss, no other cache accesses can be served, even if there is
a hit. A non-blocking cache instead has the ability to queue misses in MSHRs (miss status holding
registers) while continuing to serve hits. To make this ability useful, the
processor must be able to support either out-of-order execution or memory-stage leapfrogging.</p>
</li>
</ul>
<ul id="banked-l1-or-l2-cache">
<li><p class="first"><strong>Banked L1 or L2 Cache</strong></p>
<p>A banked cache further divides each cache way into banks, which hold separate chunks of addresses.
Each bank can be accessed in parallel, so that multiple memory accesses can begin services at once
if there is no &quot;bank conflict&quot;; that is, each request is directed to a different bank. This option
is useful for L1 for groups with a multiple-issue processor, and for L2 in the case of having both
an i-cache and d-cache miss.</p>
</li>
</ul>
<p id="branch-prediction-options"><strong>Branch Prediction Options</strong></p>
<p>All branch prediction options require an accuracy of 80% or higher on all test codes. If you fail
to achieve this accuracy, you will not get any points for the branch predictor. On the off chance
the TAs release a competition code which performs poorly using a branch predictor, this requirement
may be waived for that test code by the TAs.</p>
<ul id="local-branch-history-table">
<li><p class="first"><strong>Local Branch History Table</strong></p>
<p>This is conceptually the simplest dynamic branch prediction scheme. It contains
a table of 2-bit predictors indexed by a combination of the PC values and the history of
conditional branches at those PC values.</p>
</li>
</ul>
<ul id="global-2-level-branch-history-table">
<li><p class="first"><strong>Global 2-Level Branch History Table</strong></p>
<p>A global branch history register records the outcomes of the last N branches, which it then
combines with (some bits of) the PC to form a history table index. From there, it works the same
as the local BHT. By recording the past few branches, this scheme is able to to take advantage of
correlations between branches in order to boost the prediction accuracy.</p>
</li>
</ul>
<ul id="tournament-branch-predictor">
<li><p class="first"><strong>Tournament Branch Predictor</strong></p>
<p>A tournament branch predictor chooses between two different branch prediction schemes based on
which is more likely to be correct. You must maintain two different branch predictors (e.g., both
a local and a global predictor), and then add the tournament predictor to select between which of
the two is the best predictor to use for a branch. This predictor should use the two bit counter
method to make its selection, and should update on a per-branch basis.</p>
</li>
</ul>
<ul id="software-branch-predictor-model">
<li><p class="first"><strong>Software Branch Predictor Model</strong></p>
<p>To evaluate whether your branch predictor is performing as expected, you need to know its
expectation. To accomplish that, you can create a systemverilog model of your core and branch
predictor. This model comes with the added benefit of helping you verify the rest of your core as
well. Your branch predictor's accuracy must match the model's accuracy for points. If you do not
implement a dynamic branch prediction model, this option is only worth a single point.</p>
</li>
</ul>
<ul id="return-address-stack">
<li><p class="first"><strong>Return Address Stack</strong></p>
<p>A return address stack leverages the calling convention to better predict the target of a jump.
Refer to the RISC-V specification document for a description of the return address stack hints.
Intuitively, <tt class="docutils literal">PC+4</tt> should be pushed onto the stack when it looks like there is a call
instruction, and an instruction that looks like a function return should pop the (predicted)
return address off of the stack. This improves the BTB, since a BTB would give false predictions
for a return instruction whenever the function is called from a different call site.</p>
</li>
</ul>
<p id="prefetch-design-options"><strong>Prefetch Design Options</strong></p>
<p>Prefetching is a technique that helps us avoid cache misses. Rather than waiting for a cache miss to
perform a memory fetch, prefetching anticipates such misses and issues a fetch to the memory system
in advance of the actual memory reference. This prefetch proceeds in parallel with normal
instructions' execution, allowing the memory system to transfer the desired data to cache. Here are
several options of implementing prefetching.</p>
<ul id="basic-hardware-prefetching">
<li><p class="first"><strong>Basic Hardware Prefetching</strong></p>
<p>One block lookahead (OBL) prefetch, one of the sequential prefetching scheme that takes advantage
of spatial locality. It is easy to implement. This approach initiates a prefetch for line <tt class="docutils literal">i+1</tt>
whenever line <tt class="docutils literal">i</tt> is accessed and results in a cache miss. If <tt class="docutils literal">i+1</tt> is already cached, no
memory access is initiated.</p>
</li>
</ul>
<ul id="advanced-hardware-prefetching">
<li><p class="first"><strong>Advanced Hardware Prefetching</strong></p>
<p>PC based strided prefetching. This prefetching scheme is based on following idea:</p>
<ul class="simple">
<li>Record the distance between the memory addresses referenced by a load instruction (i.e., stride
of the load) as well as the last address referenced by the load.</li>
<li>Next time the same load instruction is fetched, prefetch last address + stride.</li>
</ul>
<p>For more detail, refer to Baer and Chen, &quot;An effective on-chip preloading scheme to reduce data
access penalty,&quot; SC 1991.</p>
</li>
</ul>
<p id="difficult-design-options"><strong>Difficult Design Options</strong></p>
<ul id="risc-v-m-extension">
<li><p class="first"><strong>RISC-V M Extension</strong></p>
<p>The RISC-V M extension specifies integer multiplication and division instructions.[#]_ The
standard competition codes call library functions which emulate integer multiplication and
division, since RV32I does not support these instructions. You will be provided with an alternate
version of the competition code compiled for RV32IM which will leverage your hardware
implementations of these operations. You are not allowed to simply use the SystemVerilog
operators, you must implement these operations explicitly in logic, exploring the trade-off
between frequency and cycles. You are not allowed to use IPs for this but you may use IPs for
other aspects of your design with the permission of your mentor TA. You must come up with your
own tests to convince your mentor TA that you have adequately tested each of the instructions in
this extension, since the compiled competition codes would not exercise each instruction
thoroughly.</p>
<p>If you use the add-shift multiplier from MP1, or a similarly &quot;simple&quot; to implement multiplier, you
will not recieve full credit for the M extension and will only get [3] points. Implementing a
more advanced multiplier (like a Wallace Tree) will earn [5] points. The final determination of
what is &quot;simple&quot; will be made by your mentor TA, so work with them in advance to fully understand
how many advanced feature points your design is eligible for.</p>
</li>
</ul>
<ul id="risc-v-c-extension">
<li><p class="first"><strong>RISC-V C Extension</strong></p>
<p>The RISC-V C extension specifies compressed 16-bit instruction formats for many common instruction
occurrences. <a class="footnote-reference" href="#footnote-5" id="footnote-reference-5">[5]</a> Note that many of the instruction formats specified are for extensions that we
are not using, so they can be ignored. As with the M extension, we will provide alternate
versions of the competition codes compiled for RV32IC and RV32IMC, and you must provide your own
test codes which adequately demonstrate the functionality of each instruction format specified in
this extension.</p>
</li>
</ul>
<p id="superscalar-design-options"><strong>Superscalar Design Options</strong></p>
<ul id="multiple-issue">
<li><p class="first"><strong>Multiple issue</strong></p>
<p>A multiple issue processor is capable of dispatching and committing multiple instructions in a
single cycle.</p>
<p>This requires modifications to several major structures in your pipeline. First, you must be
capable of fetching multiple instructions from your i-cache in a single cycle. You also must
expand your register file ports to accommodate operand fetching and simultaneous writes. Your
forwarding and hazard detection logic need to detect dependencies between in-flight instructions
in the same as well as different pipeline stages. In order to obtain the most performance
improvement for this option, you can implement it in conjunction with banked caches.</p>
</li>
</ul>
<table class="docutils footnote" frame="void" id="footnote-5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#footnote-reference-5">[5]</a></td><td>M Extension Spec: <a class="reference external" href="https://content.riscv.org/wp-content/uploads/2017/05/riscv-spec-v2.2.pdf#page=47">https://content.riscv.org/wp-content/uploads/2017/05/riscv-spec-v2.2.pdf#page=47</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="footnote-6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[6]</td><td>C Extension Spec: <a class="reference external" href="https://content.riscv.org/wp-content/uploads/2017/05/riscv-spec-v2.2.pdf#page=79">https://content.riscv.org/wp-content/uploads/2017/05/riscv-spec-v2.2.pdf#page=79</a></td></tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="design-considerations">
<h1><a class="toc-backref" href="#toc-entry-26">7&nbsp;&nbsp;&nbsp;Design Considerations</a></h1>
<p>One of the challenges in designing an OoO processor is fitting your design to the constraints of the
hardware. For example, the common data bus (CDB) connects multiple components together and can
easily create a long critical path if not carefully implemented. While we did not have you
synthesize your MP3 designs, you should be able to fully synthesisze your MP4 CPU implementation.
It is important to keep an eye on your FMAX and resource usage throughout the design process, since
trying to meet timing and resource constraints the night before the final checkpoint deadline is
never fun.</p>
<p>Some helpful tips when implementing your processor in SystemVerilog:</p>
<ul class="simple">
<li>Use efficient structures. For structures like your instruction queue, load/store queue, and
reorder buffer, use circular queues instead of a chained FIFO shift register structure. This
ensures that you are not shifting data around unnecessarily, which will help your processor save
a bit of power.</li>
<li>Know what operators to avoid. In particular, operations like <tt class="docutils literal">/</tt> (division) and <tt class="docutils literal">%</tt> (mod) can
be very expensive when synthesized into hardware. Frequently using these operators can cause
large amounts of combinational logic that create a long critical path. Instead, try using the
natural properties of binary numbers. For example, instead of having a queue of size 7 and
needing to <tt class="docutils literal">index % 7</tt>, use a power-of-two to take advantage of the automatic modulo property
as binary numbers overflow.</li>
<li>Choose your data representations wisely. You may find that the Tomasulo Algorithm described in
lecture or the textbooks is not the most efficient implementation. For example, using a 1-indexed
ROB tag with <tt class="docutils literal">0</tt> being a special &quot;not present&quot; flag value can mean needing to perform addition
and/or subtraction in multiple places when working with these tags. Depending on your design, it
may be more efficient to have a separate <tt class="docutils literal">valid</tt> bit instead of trying to incorporate such
metadata into the tag itself.</li>
<li>Parameterize your design. It might take a little longer, but having parameters to define critical
parts of your design is essential during the competition optimization process. For example, it's
a good idea to have a central location where you can define parameters such as the number of
entries in your instruction queue, the number of execution units present, the number of ROB
entries, etc. You will find that changing a single number is much easier and less error-prone
than trying to change a dozen different logic signals and constants.</li>
<li>Use interfaces and modports. When you have a group of signals that needs to be passed between
various modules, its a good idea to use an interface with modports to keep your design clean.
Examples of good places to use interfaces are memory signals (<tt class="docutils literal">mem_addr</tt>, <tt class="docutils literal">mem_rdata</tt>,
<tt class="docutils literal">mem_wdata</tt>, <tt class="docutils literal">mem_read</tt>, <tt class="docutils literal">mem_write</tt>, <tt class="docutils literal">mem_byte_enable</tt> ...) or the signals coming from
your instruction decode.</li>
<li>Unit test your design. Because of the complexity of an OoO processor, you'll have more modules to
complete before you have the chance to start running testcode. It's crucial to unit test your
modules as you make them, or else trying to debug the entire processor at once will be a lot more
difficult than debugging individual modules.</li>
</ul>
</div>
<div class="section" id="faqs">
<h1><a class="toc-backref" href="#toc-entry-27">8&nbsp;&nbsp;&nbsp;FAQs</a></h1>
<ul>
<li><p class="first"><strong>Can we use state machines for our MP4 design?</strong></p>
<p>Only in the cache hierarchy and advanced features, nowhere else. A non-pipelined cache or
multicycle functional unit (i.e., multiplier) may use a state machine as its controller.</p>
</li>
</ul>
</div>
<div class="section" id="advice-from-past-students">
<h1><a class="toc-backref" href="#toc-entry-28">9&nbsp;&nbsp;&nbsp;Advice from Past Students</a></h1>
<ul class="simple">
<li>On starting early:<ul>
<li><dl class="first docutils">
<dt>&quot;Start early. Have everything that you have implemented also in a diagram, updating while you</dt>
<dd>go.&quot;</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>&quot;START EARLY. take the design submission for next checkpoint during TA meetings seriously. it</dt>
<dd>will save you a lot of time. Front-load your advanced design work or sufferrrrr&quot;</dd>
</dl>
</li>
<li>&quot;start early and ask your TA for help.&quot;&quot;</li>
<li><dl class="first docutils">
<dt>&quot;Finish 3 days before it's due. You will need those 3 days (at least) to debug, which should</dt>
<dd>involve the creation and execution of your own tests!&quot;</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>&quot;Make the work you do in the early checkpoints bulletproof and it will make your life WAY easier</dt>
<dd>in the later stages of MP3.&quot;</dd>
</dl>
</li>
<li>Don't let a passed checkpoint stop you from working ahead. The checkpoints aren't exactly a
perfect balance of work.</li>
<li>(In an end-of-semester survey, most students responded that they spent 10-20 hours per week
working on ECE 411 assignments.)</li>
</ul>
</li>
<li>Implementation tips:<ul>
<li><dl class="first docutils">
<dt>&quot;Don't trust the TA provided hazard test code, just because it works doesn't mean your code can</dt>
<dd>handle all data and control hazards.&quot;</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>&quot;Also, it was very good to test the cache interface with the MP 2 cache, and test the bigger</dt>
<dd>cache you do (L2 cache, more ways, 8-way pseudo LRU) on the MP 2 datapath. This just makes it
easier to stay out of each other's hair.&quot;</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>&quot;Run timing analyses along the way so you're not trying to meet the 100 MHz requirement on the</dt>
<dd>last night.&quot;</dd>
</dl>
</li>
<li>&quot;Write your own test code for every case. Check for regressions.&quot;</li>
<li><dl class="first docutils">
<dt>&quot;Don't pass the control bits down the pipeline separately, pass the <em>entire</em> control word down</dt>
<dd>the pipeline. Also, pass the opcode and PC down. These are essential when debugging.&quot;</dd>
</dl>
</li>
<li>&quot;Check your sensitivity lists!!&quot;</li>
<li>&quot;Hook up the debug utilities, shadow memory and RVFI monitor, early. It helps so much later.&quot;</li>
<li><dl class="first docutils">
<dt>&quot;RISC-V MONITOR please start using it at CHECKPOINT 1!&quot;  (TA note: we suggest using RVFI Monitor</dt>
<dd>beginning with CP3.)</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>&quot;Performance counters might seem unnecessary at first, but they totally saved our competition</dt>
<dd>score. Make a lot of them, and use them!!&quot;</dd>
</dl>
</li>
</ul>
</li>
<li>Possible difficulties:<ul>
<li><dl class="first docutils">
<dt>&quot;Implement forwarding from the start, half of our bugs were in this. Take the paper design</dt>
<dd>seriously, we eliminated a lot of bugs before we started.&quot;</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>&quot;Integration is by far the most difficult part of this MP. Just because components work on their</dt>
<dd>own does not mean they will work together.''</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>&quot;The hard part about mp3 is 1) integrating components of your design together and 2) edge cases.</dt>
<dd>Really try to think of all edge cases/bugs before you starting coding. Also, be patient when
debugging.&quot;</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>&quot;You might think it makes sense to gate the clock in certain circumstances. You are almost</dt>
<dd>certainly wrong. Don't gate the clock.&quot;</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>&quot;The TAs might seem nice, but they don't give you very good testcode. Make sure to write your</dt>
<dd>own.&quot;</dd>
</dl>
</li>
</ul>
</li>
<li>On teamwork:<ul>
<li><dl class="first docutils">
<dt>&quot;Try to split up the work into areas you like -- cache vs datapath, etc. You will be in the lab</dt>
<dd>a lot, so you might as well be doing a part of the project you enjoy more than other parts&quot;</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>&quot;Don't get overwhelmed, it is a lot of work but not as much as it seems actually. As long as you</dt>
<dd>start at least a paper design ASAP, you should finish each checkpoint with no problems.&quot;</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>&quot;Come up with a naming convention and <em>stick to it</em>. Don't just name signals <tt class="docutils literal">opcode1</tt>,</dt>
<dd><tt class="docutils literal">opcode2</tt>, etc. For example, prepend every signal for a specific stage with a tag to specify
where that signal originates from (<tt class="docutils literal">EX_Opcode</tt>, <tt class="docutils literal">MEM\_Opcode</tt>).&quot;</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>&quot;Label all your components and signals as specific as possible, your team will thank you and you</dt>
<dd>will thank yourself when you move into the debugging stages!&quot;</dd>
</dl>
</li>
<li>&quot;Learn how to use Github well! It is very difficult to get through MP3 without this knowledge.&quot;</li>
<li><dl class="first docutils">
<dt>&quot;If you put in the work, you'll get results. All the tools you need for debugging are at your</dt>
<dd>disposal, nothing is impossible to figure out.&quot;</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>&quot;Split up the work and plan out which parts everyone will work on each checkpoint. You can</dt>
<dd>always help each other out, but make sure you know who is responsible for each part.&quot;</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>&quot;You need to be able to read each other's code. Agree on a style head of time, and don't rely on</dt>
<dd>others all the time. Not being able to read code makes debugging unnecessarily difficult.&quot;</dd>
</dl>
</li>
</ul>
</li>
</ul>
</div>
</div>
</body>
</html>
